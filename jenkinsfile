pipeline {
    agent any

    tools {
        maven 'maven'
          
    }

    environment {
        // Variables d'environnement pour SonarQube
        SONARQUBE_URL = 'http://sonarqube:9000'  // URL de votre instance SonarQube
        SONARQUBE_TOKEN = credentials('tokenSonar') // Token d'authentification pour SonarQube
    }

    stages {
        // Étape 1 : Intégration avec GitHub (Webhook déjà configuré)
        stage('Git Checkout') {
            steps {
                 checkout scm
                //git url: 'https://github.com/username/repository.git', branch: 'main'
            }
        }

        // Étape 2 : Compilation et tests unitaires
        stage('Build & Test') {
            steps {
                script {
                    // Utiliser Maven pour compiler le projet et exécuter les tests unitaires
                    sh 'mvn clean install -DskipTests=false'
                }
            }
        }

        stage('SonarQube Analysis') { // Ajoutez ce stage ici
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh 'mvn sonar:sonar'
                }
            }
        }
        

        // Étape 4 : Analyse de vulnérabilités (Dependency-Check)
        stage('Dependency-Check') {
            steps {
                script {
                    // Exécuter Dependency-Check pour analyser les dépendances
                    sh 'mvn org.owasp:dependency-check-maven:check'
                }
            }
        }
    }

    post {
        always {
            // Action à effectuer après l'exécution du pipeline, comme nettoyer les ressources
            cleanWs()  // Nettoyer l'espace de travail Jenkins
        }
        success {
            // Action à effectuer si le pipeline réussit
            echo 'Pipeline executed successfully!'
        }
        failure {
            // Action à effectuer en cas d'échec
            echo 'Pipeline failed!'
        }
    }
}
