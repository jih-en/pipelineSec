pipeline {
    agent any

    tools {
        maven 'Maven 3.8.8'  // Nom de votre installation Maven 3.8.8
        sonar 'SonarQube-scanner'  // Nom de votre configuration SonarQube
        dependencyCheck 'dependency-Check'  // Nom de votre installation Dependency-Check
        git 'git'  // Nom de votre configuration Git
    }

    environment {
        // Variables d'environnement pour SonarQube
        SONARQUBE_URL = 'http://sonarqube:9000'  // URL de votre instance SonarQube
        SONARQUBE_TOKEN = credentials('sonar-token') // Token d'authentification pour SonarQube
    }

    stages {
        // Étape 1 : Intégration avec GitHub (Webhook déjà configuré)
        stage('Git Checkout') {
            steps {
                // Cloner le repository Git depuis GitHub
                checkout scm
            }
        }

        // Étape 2 : Compilation et tests unitaires
        stage('Build & Test') {
            steps {
                script {
                    // Utiliser Maven pour compiler le projet et exécuter les tests unitaires
                    sh 'mvn clean install -DskipTests=false'
                }
            }
        }

        // Étape 3 : Analyse de qualité du code avec SonarQube
        stage('SonarQube Analysis') {
            steps {
                script {
                    // Analyse avec SonarQube
                    sh """
                        mvn sonar:sonar \
                            -Dsonar.projectKey=my-project \
                            -Dsonar.host.url=$SONARQUBE_URL \
                            -Dsonar.login=$SONARQUBE_TOKEN
                    """
                }
            }
        }

        // Étape 4 : Analyse de vulnérabilités (Dependency-Check)
        stage('Dependency-Check') {
            steps {
                script {
                    // Exécuter Dependency-Check pour analyser les dépendances
                    sh 'mvn org.owasp:dependency-check-maven:check'
                }
            }
        }
    }

    post {
        always {
            // Action à effectuer après l'exécution du pipeline, comme nettoyer les ressources
            cleanWs()  // Nettoyer l'espace de travail Jenkins
        }
        success {
            // Action à effectuer si le pipeline réussit
            echo 'Pipeline executed successfully!'
        }
        failure {
            // Action à effectuer en cas d'échec
            echo 'Pipeline failed!'
        }
    }
}
